import { StyledLink } from '@/components/styled-link'
import { Tabs } from 'nextra/components';
import { Callout } from 'nextra/components'

# Private channel

Private channels should be used when access to the channel needs to be restricted in some way. In order for a user to subscribe to a private channel permission must be authorized.

## Subscribe

Create a subscription to a specific channel. Provide any required parameters for public, private or presence channels.

```ts
const sub = wskit.channel('chats.$chatId', { type: 'private', params: { chatId } })
```

## Unsubscribe

Stop receiving events and clear all listeners from the subscription.

```ts
sub.dispose();
```

## Events

### Listen for an event

Subscribe to a specific event on the channel.

```ts twoslash
import { WsKit } from "websocketkit";
import Pusher from 'pusher-js';

type UserIsTypingWhisper = {
    userId: string;
}

declare module 'websocketkit' {
  interface ChannelRegistry {
    'orders': {
      type: 'private';
      params: {};
      events: {
        orderProcessed: {
          orderId: string,
          status: number
        }
      };
    };
  }
}

const pusher = new Pusher('TEST', {cluster: 'mt1'});
const wskit = new WsKit(pusher);
const sub = wskit.subscribe('orders', {type: 'private', params: {}});
// ---cut---
sub.on('orderProcessed', (event) => {
  /** Do something with the event **/
})
```

### Stop listening for an event

<Callout type="important">
  This should only be used when you want to stop listening for a specific event without unsubscribing from the channel; otherwise, calling `sub.dispose()` is sufficient.
</Callout>

Remove a specific listener using either the returned unsubscribe function or the original callback reference.

<Tabs items={['Using returned unsubscribe function', 'Using original callback reference']}>
  <Tabs.Tab>
    ```ts
    const unsub = sub.on('messageReceived', (event) => {
    console.log(event.message);
  })

    // Later
    unsub();
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```ts
    const messageReceivedHandler = (event) => {
    console.log(event);
  };

    sub.on('messageReceived', messageReceivedHandler)

    // Later
    sub.off(messageReceivedHandler);
    ```
  </Tabs.Tab>
</Tabs>

## Notifications

### Listen for a notification

Listen for `.Illuminate\\Notifications\\Events\\BroadcastNotificationCreated` event on a channel.

```ts
sub.notification((notif) => {
  console.log(notif)
});
```

### Stop listening for a notification

<Callout type="important">
  This should only be used when you want to stop listening for a specific event without unsubscribing from the channel; otherwise, calling `sub.dispose()` is sufficient.
</Callout>

<Tabs items={['Using returned unsubscribe function']}>
  <Tabs.Tab>
    ```ts
    // Using returned unsubscribe function
    const unsub = sub.notification((notif) => {
      console.log(notif)
    });

    unsub()
    ```
  </Tabs.Tab>
</Tabs>

## Client Events

Communicate directly with other subscribers on the channel.

### Send a whisper

```ts
sub.whisper('userIsTyping', { userId });
```

### Listen for a whisper

<Callout type="important">
  This should only be used when you want to stop listening for a specific event without unsubscribing from the channel; otherwise, calling `sub.dispose()` is sufficient.
</Callout>

```ts
sub.listenForWhisper('userIsTyping', (event) => {
  console.log(event);
});
```
### Stop listening for a whisper

<Tabs items={['Using returned unsubscribe function', 'Using original callback reference']}>
  <Tabs.Tab>
    ```ts
    // Using returned unsubscribe function
    const unsub = sub.listenForWhisper('userIsTyping', (event) => {
      console.log(event);
    });

    unsub();
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```ts
    // Using original callback reference
    const userIsTypingHandler = (event) => {
      console.log(event);
    }

    sub.listenForWhisper('userIsTyping', userIsTypingHandler);

    // Later
    sub.stopListeningForWhisper('userIsTyping', userIsTypingHandler);
    ```
  </Tabs.Tab>
</Tabs>

## Internal Events

### Subscription succeeded

Triggered when the subscription is successfully established.

```ts
sub.subscribed(() => {
  /** Do something after successful subscription **/
})
```

### Subscription error

Triggered when authorization fails for private or presence channels. Internally, this listens for the `pusher:subscription_error` <StyledLink href="https://pusher.com/docs/channels/using_channels/events/#pushersubscription_error-1995773905">event</StyledLink>.

```ts
sub.error((error) => {
  /** Handle subscription error **/
})
```